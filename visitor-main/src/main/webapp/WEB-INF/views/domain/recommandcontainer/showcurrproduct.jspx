<html xmlns:util="urn:jsptagdir:/WEB-INF/tags/util" xmlns:jsp="http://java.sun.com/JSP/Page" xmlns:decorator="http://www.opensymphony.com/sitemesh/decorator" xmlns:c="http://java.sun.com/jsp/jstl/core"  xmlns:fmt="http://java.sun.com/jsp/jstl/fmt" xmlns:form="http://www.springframework.org/tags/form" xmlns:security="http://www.springframework.org/security/tags" xmlns:spring="http://www.springframework.org/tags">

<jsp:output omit-xml-declaration="yes" />
<jsp:directive.page contentType="text/html; charset=UTF-8" />

<head>
<title><spring:message code="folder" />: <spring:message code="crud.functionalities.list" /></title>

	<script type="text/javascript">
		$(document).ready(function() {
			$(".sortclass").click(function(){
				var theDate = $(this).attr("id").substring(4);
				
				//清除UL里的元素
				$("#sortable li").remove();
				//依次添加对应表格里面的内容
				var sortUl=$("#sortable");
				$("#tb"+theDate+" tr:gt(1)").each(function() {
					var taskid = $(this).children().eq(5);
					var pname = $(this).children().eq(1);
					if (taskid.text().trim() != '') {
						var $li_1 = $("&lt;li id='"+taskid.text().trim()+"' class='ui-state-default'&gt;"+pname.next().text().trim()+"&lt;/li&gt;");
						sortUl.append($li_1);
					}
				 });
						
				$( "#sort_area" ).show();
				$( "#cover_body" ).css({width:$(document).width(),height:$(document).height()}).show();
				
			});	
			
			$(".addclass").click(function(){
				var theDate = $(this).attr("id").substring(3);
				$("#showDate").text(theDate.substring(0,4)+"年"+theDate.substring(4,6)+"月"+theDate.substring(6)+"日");	
				$("#addCurrDate").val(theDate);
				
				$( "#add_area" ).show();
				$( "#cover_body" ).css({width:$(document).width(),height:$(document).height()}).show();
				
			});	
			
			/*save*/
			$("#sort_save").click(function(){
				var productIdrs = $("#sortable").sortable('toArray');
				//alert(productIdrs);
				$.ajax( {
					type : "GET",
					url : "${pageContext.request.contextPath}/domain/recommandcontainer/sortTask?productContainers=" + productIdrs,
					success : function(ss) {
						if(ss){
							window.document.location.href="${pageContext.request.contextPath}/domain/recommandcontainer/showcurrproduct/${recommandContainer.primaryKey}?pageId=${pageId}";
						}else{
							
						}
					}
				})
			});
			/*save for add new */
			$("#add_save").click(function(){
				
				
				var productIds = $("#productIds").val();
				var ok = true;
				if(productIds == ""){
					$("#errorInfo").text("产品ID不能为空！");
					ok = false;
				}else {
					
					productIds = productIds.replace(/，/g,",");
					var prdArrays = productIds.split(",");
					for(var i=0;i &lt; prdArrays.length;i++){
						if(isNaN(prdArrays[i])){
							$("#errorInfo").text(prdArrays[i]+"不是数字！");
							ok = false;
							break;
						}
					}
				}
				
				if(ok){
					$("#errorInfo").text("");
					$.ajax( {
						type : "GET",
						url : "${pageContext.request.contextPath}/domain/recommandcontainer/addproducttaskwithoutdate?productIds=" + productIds + "&amp;onedate="+$("#addCurrDate").val()+"&amp;containerId=${recommandContainer.primaryKey}&amp;type="+$('[name="add_type"][checked=true]:radio').val(),
						success : function(ss) {
							if(ss){
								window.document.location.href="${pageContext.request.contextPath}/domain/recommandcontainer/showcurrproduct/${recommandContainer.primaryKey}?pageId=${pageId}";
							}else{
								$("#errorInfo").text("添加失败，可能原因是：1）找不到该产品 2）该产品在当天已经添加过 3）其它错误，请检查！");
							}
						}
					})
				}
			});
			
			/*cancel*/
			$("#sort_cancel").click(function(){
				$( "#sort_area" ).hide();
				$( "#cover_body" ).hide();
			});

			/*cancel*/
			$("#add_cancel").click(function(){
				//清除
				$("#errorInfo").text("");
				$("#productIds").val("");
				
				$( "#add_area" ).hide();
				$( "#cover_body" ).hide();
			});

			/*move*/
			$( "#sortable" ).sortable();
			$( "#sortable" ).sortable('option', 'axis', 'y');
			$( "#sortable" ).sortable('option', 'opacity', 0.5);
			$( "#sortable" ).sortable('option', 'revert', true);
			$( "#sortable" ).sortable('option', 'items', 'li');
			
		});
	</script>
	<STYLE>
		#sortable { list-style-type: decimal; margin: 0px 0px 0px 12px; padding: 0; width: 100%; }
		#sortable li { cursor: move; margin: 0 2px 1px 12px; padding : 0.1em 0.4em 0.5em 1.0em; font-size: 1.0em; height: 16px; border: 1px solid #AAAAAA; border-radius: 4px 4px 4px 4px;}
	</STYLE>


</head>
<body>
	<div id="result">
		<a href="${pageContext.request.contextPath}/domain/recommandcontainer/search" class="ajaxy button button-search"><spring:message code="recommandContainer" /></a>
		<a href="${pageContext.request.contextPath}/domain/recommandcontainer/showproduct/${recommandContainer.primaryKey}?pageId=${pageId}" class="ajaxy button button-search">
			<spring:message code="crud.show.button" />
		</a>
		
		<a href="${pageContext.request.contextPath}/domain/recommandcontainer/addproduct?containerId=${recommandContainer.primaryKey}&amp;pageId=${pageId}" class="ajaxy button button-create"><spring:message code="recommandContainer_add" /></a>
		<a href="${pageContext.request.contextPath}/domain/recommandcontainer/replaceproduct/${recommandContainer.primaryKey}?pageId=${pageId}" class="ajaxy button button-show"><spring:message code="recommandContainer_show_replace_prd" /></a>
		<span class="ui-state-highlight button button-show">
			<spring:message code="recommandContainer_show_currDate_prd" />
		</span>

								<table class="edit"  id="tb${todayDate}">
									<thead>
										<tr>
										    <th style="width:5%">NO.</th>
											<th style="width:10%"><spring:message code="productList_productId" /></th>
											<th style="width:25%"><spring:message code="productList_name" /></th>
											<th style="width:10%"><spring:message code="productContainerTask_type" /></th>
											<th style="width:10%"><spring:message code="productContainerTask_status" /></th>
											<th style="width:5%"><spring:message code="productContainerTask_productContainerId" /></th>
											<th style="width:10%"><spring:message code="productContainer_modBy" /></th>
											<th style="width:15%"><spring:message code="productContainer_modDate" /></th>
											<th style="width:10%"><spring:message code="productContainer_operation" /></th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td colspan="5" style="text-align:center">
												<fmt:parseDate value="${todayDate}" type="date" var="date_date" pattern="yyyyMMdd"/>
												<fmt:formatDate value="${date_date}" type="date" pattern="yyyy年MM月dd日"/>
											</td>
											<td colspan="4">
												<!-- 排序和添加的操作 -->
												<a id="sort${todayDate}" href="#" class="ajaxy button sortclass"><spring:message code="crud.sort.button" /></a>
												&amp;nbsp;&amp;nbsp;
												<a id="add${todayDate}" href="#" class="ajaxy button addclass"><spring:message code="recommandContainer_add" /></a>
												&amp;nbsp;&amp;nbsp;
												<a href="${pageContext.request.contextPath}/domain/productcontainertask/deletebydate/${recommandContainer.primaryKey}/${todayDate}/" class="button modal miniature"><spring:message code="crud.clear.button"/></a>
												&amp;nbsp;&amp;nbsp;
												<a href="${pageContext.request.contextPath}/domain/init/redis/productContainer/task/${recommandContainer.primaryKey}/${todayDate}/" class="modal button button"><spring:message code="crud.redis.publish.button"/></a>
											</td>
										</tr>
										<c:set value="" var="idList" />
										<c:forEach items="${productContainerTasks}" var="productContainerTask" varStatus="status">
											<tr>
													<td>
														${status.index+1}
													</td>
												<c:if test="${productContainerTask.type==1}">
													<td>
														${productContainerTask.product.productId}
														<c:choose>
															<c:when test="${idList != ''}">
														    	<c:set value="${idList},${productContainerTask.product.productId}" var="idList" />
															</c:when>
															<c:otherwise>
															    <c:set value="${productContainerTask.product.productId}" var="idList" />
															</c:otherwise>
														</c:choose>
													</td>
													<td>
														<a href="${pageContext.request.contextPath}/domain/productlist/show/${productContainerTask.product.productId}">${productContainerTask.product.name}</a>
													</td>
													<td>
														<spring:message code="productContainerTask_type_Product" />
													</td>
													<td>
														<c:if test="${productContainerTask.product.downStatus==0}"><spring:message code="productList_status_enable" /></c:if>
														<c:if test="${productContainerTask.product.downStatus==1}"><font color="red"><spring:message code="productList_status_disable" /></font></c:if>
													</td>
												</c:if>
												<c:if test="${productContainerTask.type==2}">
													<td>
														${productContainerTask.tfolder.folderId}
													</td>
													<td>
														<a href="${pageContext.request.contextPath}/domain/folder/show/${productContainerTask.tfolder.folderId}">${productContainerTask.tfolder.name}</a>
													</td>
													<td>
														<spring:message code="productContainerTask_type_Folder" />
													</td>
													<td>
														<c:if test="${productContainerTask.tfolder.status==0}"><spring:message code="folder_status_yes" /></c:if>
														<c:if test="${productContainerTask.tfolder.status==1}"><font color="red"><spring:message code="folder_status_yes" /></font></c:if>
													</td>
												</c:if>
												<c:if test="${productContainerTask.type==3}">
													<td>
														${productContainerTask.advertise.advertiseId}
													</td>
													<td>
														<a href="${pageContext.request.contextPath}/domain/advertise/show/${productContainerTask.advertise.advertiseId}">${productContainerTask.advertise.name}</a>
													</td>
													<td>
														<spring:message code="productContainerTask_type_Advertise" />
													</td>
													<td>
														<c:if test="${productContainerTask.advertise.status==0}"><spring:message code="advertise_status_enable" /></c:if>
														<c:if test="${productContainerTask.advertise.status==1}"><font color="red"><spring:message code="advertise_status_disable" /></font></c:if>
													</td>
												</c:if>
												<td>
													${productContainerTask.productContainerTaskId}
												</td>
												<td>
													${productContainerTask.modBy}
												</td>
												<td>
													<fmt:formatDate value="${productContainerTask.modDate}" type="date" pattern="yyyy-MM-dd"/>
												</td>
												<td>
													<a href="${pageContext.request.contextPath}/domain/productcontainertask/delete/${productContainerTask.primaryKey}?pageType=1&amp;pageId=${pageId}" class="button button-delete modal miniature"><spring:message code="crud.delete.button"/></a>
												</td>
											</tr>
										</c:forEach>
										<tr><td colspan="9" style="word-break:break-all">ID排序（仅限于产品）：${idList}</td></tr>
									</tbody>
								</table><!-- 以上为该天数据 -->

	</div>

				<!-- sort -->
				<div id="sort_area" class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-draggable ui-resizable" style="display: none; z-index: 1002; outline: 0px none; position: absolute; height: auto; width: 300px; top: 120px; left: 478px;">
					<div class="ui-dialog-content" style="width: auto; min-height: 102.267px; height: auto;">
						<div>
							<ul id="sortable">
								<li>nothing</li>
							</ul>
						</div>
						<div style="padding-left: 5.5em;">
							<spring:message code="crud.save.button" var="saveButton"/>
							<input id="sort_save" type="button" class="button" value="${saveButton}"/>
							<spring:message code="crud.cancel.button" var="sortButton"/>
							<input id="sort_cancel" type="button" class="button" value="${sortButton}"/>
						</div>
					</div>
				</div>
				<!-- add_new -->
				<div id="add_area" class="ui-dialog ui-widget ui-widget-content ui-corner-all ui-draggable ui-resizable" style="display: none; z-index: 1002; outline: 0px none; position: absolute; height: auto; width: 500px; top: 220px; left: 378px;">
					<div class="ui-dialog-content" style="width: auto; min-height: 102.267px; height: auto;">
						<div>
							<table style="width:100%">
								<tbody>
									<!--产品类型-->
									<tr>
										<th style="width:25%">
											<spring:message code="productContainerTask_type" />
										</th>
										<td>
											<input type="radio" name="add_type" value="1" checked="checked"/><spring:message code="productContainerTask_type_Product" />
											<input type="radio" name="add_type" value="2" /><spring:message code="productContainerTask_type_Folder" />
											<input type="radio" name="add_type" value="3" /><spring:message code="productContainerTask_type_Advertise" />
										</td>
									</tr>
									<tr>
										<th>
											<spring:message code="productContainerTask_Id" />
										</th>
										<td>
											<input type="text" id="productIds" name="productIds" class="required {maxlength: 200}" maxlength="200"  size="50" value="${product}"/>
											<br/><span>提示：多个ID值请使用“,”或“，”来分隔</span>
											<input type="hidden" id="addCurrDate" value="" />
										</td>
									</tr>
									<tr>
										<th>
											<spring:message code="productContainerTask_displayDate" />
										</th>
										<td><span id="showDate">nothing</span></td>
									</tr>
								</tbody>
							</table>
							<span style="color:red" id="errorInfo">&amp;nbsp;</span><br/>
						</div>
						<div style="text-align:center;">
							<spring:message code="crud.save.button" var="saveButton"/>
							<input id="add_save" type="button" class="button" value="${saveButton}"/>
							&amp;nbsp;&amp;nbsp;
							<spring:message code="crud.cancel.button" var="sortButton"/>
							<input id="add_cancel" type="button" class="button" value="${sortButton}"/>
						</div>
					</div>
				</div>
				<!-- show by product end-->
				<div id="cover_body" class="ui-widget-overlay" style="display:none; z-index: 1001;"></div>

</body>
</html>