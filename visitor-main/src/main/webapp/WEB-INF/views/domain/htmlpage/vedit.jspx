<html xmlns:util="urn:jsptagdir:/WEB-INF/tags/util" xmlns:jsp="http://java.sun.com/JSP/Page" xmlns:decorator="http://www.opensymphony.com/sitemesh/decorator" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:form="http://www.springframework.org/tags/form" xmlns:security="http://www.springframework.org/security/tags" xmlns:spring="http://www.springframework.org/tags">

<jsp:output omit-xml-declaration="yes" />
<jsp:directive.page contentType="text/html; charset=UTF-8" />
<head>
	<title><spring:message code="htmlPage" />: <spring:message code="crud.functionalities.update" /></title>
	<style type="text/css">
	
		#addNewDiv{
			display: none;
			position: static;
		}
		#newItemDiv{
			z-index: 2;
			position: absolute;
			background-color: #fff;
			padding: 20px;
			-moz-border-radius: 5px;
			-webkit-border-radius: 5px;
			-o-border-radius: 5px;
			border-radius: 5px;
			width:500px;
		}

		#editParamDiv{
			display: none;
			position: static;
		}
		#paramDiv{
			z-index: 2;
			position: absolute;
			background-color: #fff;
			padding: 20px;
			-moz-border-radius: 5px;
			-webkit-border-radius: 5px;
			-o-border-radius: 5px;
			border-radius: 5px;
			width:500px;
		}
		
		.mask{
			z-index: 1;
			position: absolute;
			background-color: #000;
			opacity: 0.5;
			-moz-opacity: 0.5;
			filter:alpha(opacity=5);
			top: 0;
			width: 100%;
			left: 0;
		}
		
		textarea {
    		height: 100px;
    		padding: 5px;
    		width: 260px;
		}
		
		select {
    		width:260px;
		}
	</style>
		
</head>
<body>
	<c:set var="testValue" value="abcdefg" />
	<a href="${pageContext.request.contextPath}/domain/folder/show/${htmlPage.folderId}" class="ajaxy button button-show"><spring:message code="crud.show.button" /></a>
	<span class="ui-state-highlight button button-edit"><spring:message code="folder_page_operate_visual_edit" /></span>
	<c:if test="${htmlPage.pageId != null and htmlPage.pageId != 0}">
		<c:if test="${!empty templateList}">
		<span class="ui-state-highlight button button-show">当前编辑页面：${folder.name} -- ${pageTypeName}</span>
		<table id="tbitem" class="edit">
			<thead>
				<tr>
					<th style="width:10%"><spring:message code="template_order" /></th>
					<th style="width:10%"><spring:message code="template_templateId" /></th>
					<th style="width:20%"><spring:message code="template_name" /></th>
					<th style="width:20%"><spring:message code="template_type" /></th>
					<th style="width:15%;text-align:left"><spring:message code="template_params" /></th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<c:forEach items="${templateList}" var="templateItem" varStatus="status">
					<c:set var="template" value="${templateItem.template }" />
					<tr>
						<td>${status.index+1 }</td>
						<td>${template.templateId}</td>
						<td>
							<a href="${pageContext.request.contextPath}/domain/template/show/${template.templateId}">${template.name}</a>
						</td>
						<td>
							<c:choose>
								<c:when test="${template.type == 0}">
									<spring:message code="template_type_0" />
								</c:when>
								<c:when test="${template.type == 1}">
									<spring:message code="template_type_1" />
								</c:when>
								<c:when test="${template.type == 2}">
									<spring:message code="template_type_2" />
								</c:when>
								<c:otherwise>
									<spring:message code="template_type_3" />
								</c:otherwise>
							</c:choose>
						</td>
						<td>
							<c:if test="${not empty templateItem.params}">
								<c:forEach items="${templateItem.params}" var="paramItem" >
									${paramItem.key} = ${paramItem.value}<br/>
								</c:forEach>
							</c:if>
						</td>
						<td>
							<a href="#" class="button button-delete" onclick="javascript:deleteItem(${status.index})">
								<spring:message code="crud.delete.button"/>
							</a>
							<c:if test="${template.type == 2}">
								<a href="#" class="button button-edit" onclick="javascript:showEditDiv(${status.index})"><spring:message code="crud.editparam.button"/></a>
							</c:if>
						</td>
					</tr>
				</c:forEach>
			</tbody>
			<tfoot>
				<td colspan="8" align="center">
					<a id="addNew" class="button button-create"><spring:message code="crud.addnew.button"/></a>
					<a href="#" class="button button-save"><spring:message code="crud.save.button"/></a>
					<a href="#" class="button button-publish"><spring:message code="crud.redis.publish.button"/></a>
				</td>
			</tfoot>
		</table>
		</c:if>	
		<c:if test="${!empty pageContainers}">
		<span class="ui-state-highlight button button-show"><spring:message code="recommandContainer" /></span>
		<table class="edit">
			<thead>
				<tr>
					<th style="width:10%"><spring:message code="recommandContainer_containerId" /></th>
					<th style="width:15%"><spring:message code="recommandContainer_name" /></th>
					<th style="width:30%"><spring:message code="recommandContainer_modDate" /></th>
					<th style="width:10%"><spring:message code="recommandContainer_modBy" /></th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<c:forEach items="${pageContainers}" var="pageContainer" varStatus="status">
					<tr>
						<td>
							<a href="${pageContext.request.contextPath}/domain/recommandcontainer/show/${pageContainer.container.containerId}">${pageContainer.container.containerId}</a>
						</td>
						<td>
							${pageContainer.container.name}
						</td>
						<td>
							${pageContainer.container.modDate}
						</td>
						<td>
							${pageContainer.container.modBy}
						</td>
						<td>
							<a href="${pageContext.request.contextPath}/domain/recommandcontainer/show/${pageContainer.container.containerId}" class="button button-show"><spring:message code="crud.show.button"/></a>
						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
		</c:if>
	</c:if>
	
	
	<div id="addNewDiv">
		<div id="newItemDiv">		
			<table width="100%" height="100%">
				<tr>
					<td colspan="2"><center>添加新的模板元素</center></td>
				</tr>
				<tr>
					<td>模板类型:</td>
					<td>
						<input id="tmpStyle1" name="tmpStyle" value="0" type="radio" checked="true" /><span><spring:message code="template_type_0" /></span>
						<input id="tmpStyle2" name="tmpStyle" value="1" type="radio" /><span><spring:message code="template_type_1" /></span>
						<input id="tmpStyle3" name="tmpStyle" value="2" type="radio" /><span><spring:message code="template_type_2" /></span>
					</td>
				</tr>
				<tr>
					<td>模板名称:</td>
					<td>
						<select id="tmpList" name="tmpList">
							<option option="0">请选择</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>模板参数:</td>
					<td>
						<div id="noparam">不必填写</div>
						<div id="showparam">
							<textarea rows="10" cols="30" id="paramContent">
							&amp;nbsp;
							</textarea><br/>*注：请按参数名＝参数值的方式填写（如：maxCount＝5），每行限填一个参数信息
						</div>
					</td>
				</tr>
				<tr>
					<td>添加位置:</td>
					<td>
						<select id="tmpPos">
							<option option="0">第一行之前</option>
							<option option="1">第一行之后</option>
						</select>						
					</td>
				</tr>
				<tr >
					<td colspan="2" align="center">
						<center>
							<spring:message code="crud.save.button" var="saveName"/>
							<input id="btnOk" class="button button-save" type="button" value="${saveName}"/>
							<spring:message code="crud.cancel.button" var="cancelName" />
							<input id="btnCancel"  class="button button-cancel" type="button" value="${cancelName}"/>
						</center>
					</td>
				</tr>			
			</table>
		</div>
		<div id="mask1" class="mask">&amp;nbsp;</div>
	</div>

	<div id="editParamDiv">
		<div id="paramDiv">		
			<table width="100%" height="100%">
				<tr>
					<td colspan="2"><center>修改模板参数</center></td>
				</tr>
				<tr>
					<td>模板名称:</td>
					<td><span id="tmpName">&amp;nbsp;</span><input type="hidden" id="currTmpId" value="" /></td>
				</tr>
				<tr>
					<td>模板参数:</td>
					<td>
						<textarea rows="10" cols="30" id="paramContent2">
							&amp;nbsp;
						</textarea><br/>*注：请按参数名＝参数值的方式填写（如：maxCount＝5），每行限填一个参数信息
					</td>
				</tr>
				<tr >
					<td colspan="2" align="center">
						<center>
							<spring:message code="crud.save.button" var="saveName"/>
							<input id="btnParamOk" class="button button-save" type="button" value="${saveName}"/>
							<spring:message code="crud.cancel.button" var="cancelName" />
							<input id="btnParamCancel"  class="button button-cancel" type="button" value="${cancelName}"/>
						</center>
					</td>
				</tr>			
			</table>
		</div>
		<div id="mask2" class="mask">&amp;nbsp;</div>
	</div>
	
	<script type="text/javascript">	
		/*删除一行记录*/
		function deleteItem(rowId){
			if(!confirm('您真的要删除这一行吗？')){
				alert($(this).val());

				return;
			}
			
			/*1.将其后面的每行的排序值减1*/
			var aftCurrentRow = $('#tbitem tbody tr:gt('+rowId+')');
			aftCurrentRow.each(function(){
				var node = $(this).children("td:first");
				node.text(Number(node.text())-1);
			});
			
			/*移除本行*/
			$('#tbitem tbody tr:eq('+rowId+')').remove();
		}
		
		/*显示编辑框*/
		function showEditDiv(rowId){
			//alert("called");
			var $doc = $(document);
			var $form = $('#paramDiv');
			
			/*更新数据*/
			var currentRow = $('#tbitem tbody tr:eq('+rowId+')');
			var tmpName = currentRow.children("td:eq(2)").text();
			var paramContent = currentRow.children("td:eq(4)").text();
			
			$('#tmpName').text(tmpName);
			$('#paramContent2').val(paramContent);
			$('#currTmpId').val(rowId);
			
			$('#editParamDiv').show();
			var top = Math.max((($doc.outerHeight() - $form.outerHeight()) / 2)-100, 0);
			var left = Math.max((($doc.outerWidth() - $form.outerWidth()) / 2), 0);
			
			$form.offset({top: top, left: left});
			
			$('#mask2').css('height', $doc.outerHeight());
		}

		$(document).ready(function(){
			
			var showAddNewDiv = function(){
				var $doc = $(document);
				var $form = $('#newItemDiv');
				
				$('#addNewDiv').show();
				var top = Math.max((($doc.outerHeight() - $form.outerHeight()) / 2)-100, 0);
				var left = Math.max((($doc.outerWidth() - $form.outerWidth()) / 2), 0);
				
				$form.offset({top: top, left: left});
				
				$('#mask1').css('height', $doc.outerHeight());
			};
			
			var initList = function(index){
				
				$('#tmpList')[0].options.length = 0;
				$('#tmpList')[0].options.add(new Option('--请选择--','0'));
				
				var items = tempInfo[index].item;
				var item_len = items.length;
				for(var i=0;i &lt; item_len;i++){
					$('#tmpList')[0].options.add(new Option(items[i].tmpName,items[i].tmpId));
				}
				
				$('#tmpList')[0].selectedIndex = 0;
			};	
			
			/*初始化位置下拉框*/
			var initPosList = function(){
				$('#tmpPos')[0].options.length = 0;
				$('#tmpPos')[0].options.add(new Option("添加到最前面",0));
				
				$("#tbitem tbody tr").each(function(){
					var sortId = $(this).children("td:first").text();
					var text = $(this).children("td:eq(2)").text();
					
					$('#tmpPos')[0].options.add(new Option("添加到第"+sortId+"行:'"+text+"'之后",sortId));
				});
				
				$('#tmpPos')[0].selectedIndex = 0;
			};
			
			var validCheck = function(){
				return true;
			};
			
			/*add a new row*/
			var addNewRow = function(){
				var tmpPos = $('#tmpPos').val();/*位置*/
				var tdIndex = (tmpPos -1)>0 ? (tmpPos-1) : 0;
				var aftCurrentRow = $('#tbitem tbody tr:gt('+tdIndex+')');
				/*这里遇到一个问题，使用ge，程序出错，gte的话呢，
				 * 后续的循环又不执行，所以暂时还是用gt，这样就不包括当前行了
				*/
				/*将后续的每一行的位置值加1*/
				aftCurrentRow.each(function(){
					var node = $(this).children("td:first");
					node.text(Number(node.text())+1);
				});
				
				var currentRow = $('#tbitem tbody tr:eq('+tdIndex+')');
				/*显示渲染，不知道为什么*/
				var btnCss ="button button-delete ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-primary";
				var htmDeleteBtn = "&lt;span class='ui-button-icon-primary ui-icon ui-icon-trash'&gt;&lt;/span&gt;&lt;span class='ui-button-text'&gt;删除&lt;/span&gt;";
				var htmEditBtn = "&lt;span class='ui-button-icon-primary ui-icon ui-icon-pencil'&gt;&lt;/span&gt;&lt;span class='ui-button-text'&gt;修改参数&lt;/span&gt;";
								
				var newRow="&lt;tr&gt;";
				/*第一列,位置序号*/
				newRow+="&lt;td&gt;"+(Number(tmpPos)+1)+"&lt;/td&gt;";
				/*第二列*/
				newRow+="&lt;td&gt;"+$('#tmpList').val()+"&lt;/td&gt;";
				/*第三列*/
				newRow+="&lt;td&gt;&lt;a href='${pageContext.request.contextPath}/domain/template/show/"+$('#tmpList').val()+"'&gt;"+$('#tmpList').find("option:selected").text()+"&lt;/a&gt;&lt;/td&gt;";
				/*第四列*/
				newRow+="&lt;td&gt;"+$('input[name=tmpStyle]:checked').next().text()+"&lt;/td&gt;";
				/*第五列，参数*/
				newRow+="&lt;td&gt;"+$('#paramContent').val()+"&lt;/td&gt;";
				/*第六列，操作选项*/
				newRow+="&lt;td&gt;&lt;a href='#' onclick=deleteItem("+tmpPos+") class='"+btnCss+"'&gt;"+htmDeleteBtn+"&lt;/a&gt;";
				if($('input[name=tmpStyle]:checked').val()=="2"){
					/*如果是Tiles组件，需要编辑参数*/
					newRow+="&lt;a href='#' onclick=showEditDiv("+tmpPos+") class='"+btnCss+"'&gt;"+htmEditBtn+"&lt;/a&gt;";
				}
				
				newRow+="&lt;/td&gt;&lt;/tr&gt;";
				//alert($('input[name=tmpStyle]:checked').val());
				//add a new line
				if(tmpPos > 0){
					currentRow.after(newRow);//insert into the proper position
				}else{
					currentRow.before(newRow);//insert the row as the first row
					/*只有在这种情况下，当前行值才需要更新*/
					var currNode = $(currentRow).children("td:first");
					currNode.text(Number(currNode.text())+1);
				}
			};
			
			$('#addNew').click(function(){
				showAddNewDiv();
				initPosList();
			});
		
			$('#btnCancel').on('click', function(){
				$('#addNewDiv').hide();
			});
			
			/*关闭修改参数的窗口*/
			$('#btnParamCancel').on('click', function(){
				$('#editParamDiv').hide();
			});
			
			$('#btnOk').on('click',function(){
				/*有效性检查*/
				if(validCheck()==true){
					addNewRow();
					$('#addNewDiv').hide();
				}
			});
			
			$('#btnParamOk').on('click',function(){
				/*有效性检查*/
				if(validCheck()==true){
					/*更新参数*/
					//alert($('#paramContent2').text());
					var currentNode = $('#tbitem tbody tr:eq('+$('#currTmpId').val()+')').children("td:eq(4)");
					currentNode.text($('#paramContent2').val());
					//alert(currentNode.val());
					$('#editParamDiv').hide();
				}
			});
			
			$('input[name=tmpStyle]').change(function () {
	            var lstIndex = $(this).val();
	            initList(lstIndex);
	            
	            if(lstIndex==2){
	    		    $('#noparam').hide();
	    		    $('#showparam').show();
	            }else{
	    		    $('#noparam').show();
	    		    $('#showparam').hide();
	            }
	            
	        });
			
			/*初始化*/
		    var tempInfo = eval('${tempJson}');
		    initList(0);	
		    
		    $('#noparam').show();
		    $('#showparam').hide();
		});
		
	</script>
</body>
</html>